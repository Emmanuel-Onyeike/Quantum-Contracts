<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TechNxxt Support Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    /* Custom CSS for slide-out menu */
    .slide-out-menu {
      transform: translateX(100%);
      transition: transform 0.3s ease-in-out;
    }
    .slide-out-menu.open {
      transform: translateX(0);
    }
    .modal-overlay {
      z-index: 100;
    }
    /* Ensure no horizontal scrolling on smaller screens */
    html, body {
      overflow-x: hidden;
    }
    /* Skeleton Loader */
    .skeleton-loader {
      background-color: #1a1a1a;
      border-radius: 0.5rem;
      animation: pulse 1.5s infinite ease-in-out;
    }
    .skeleton-loader-text {
        height: 1rem;
        margin-bottom: 0.5rem;
    }
    .skeleton-loader-card {
        height: 6rem;
    }
    @keyframes pulse {
      0% { opacity: 0.8; }
      50% { opacity: 0.5; }
      100% { opacity: 0.8; }
    }
    /* Scrollable Activity Log */
    .activity-log {
        max-height: 20rem; /* Adjust this value as needed */
        overflow-y: auto;
    }
  </style>
</head>
<body class="bg-black text-gray-200 font-sans">
  <header class="md:hidden sticky top-0 bg-black/80 backdrop-blur-sm z-40 p-4 border-b border-gray-700 flex items-center justify-between">
    <h1 id="page-title-mobile" class="text-xl font-bold capitalize">Overview</h1>
    <button id="openMenu" class="p-2 rounded-lg bg-gray-800 text-white">
      <i class="fas fa-bars"></i>
    </button>
  </header>

  <div class="flex min-h-screen">
    <aside id="desktop-sidebar" class="hidden md:flex w-64 flex-col bg-black border-r border-gray-700">
      <div class="p-6 border-b border-gray-700">
        <h2 class="text-2xl font-bold text-white">TechNxxt</h2>
        <p class="text-sm text-gray-400">Support Dashboard</p>
      </div>
      <nav class="flex-1 p-4 flex flex-col gap-2">
        <button class="nav-btn flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-800" data-tab="overview">
          <i class="fas fa-chart-line"></i> Overview
        </button>
        <button class="nav-btn flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-800" data-tab="contract">
          <i class="fas fa-file-contract"></i> Contract
        </button>
        <button class="nav-btn flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-800" data-tab="dust">
          <i class="fas fa-magic"></i> Dust
        </button>
        <button class="nav-btn flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-800" data-tab="billing">
          <i class="fas fa-receipt"></i> Billing
        </button>
        <button class="nav-btn flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-800" data-tab="payment">
          <i class="fas fa-dollar-sign"></i> Payment
        </button>
        <button class="nav-btn flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-800" data-tab="settings">
          <i class="fas fa-cog"></i> Settings
        </button>
      </nav>
      <div class="p-4 border-t border-gray-700 text-sm text-gray-500">
        © 2025 TechNxxt
      </div>
    </aside>

    <main class="flex-1 p-6 pt-20 md:pt-6">
      <h1 id="page-title" class="hidden md:block text-3xl font-bold mb-6 capitalize">Overview</h1>

      <div id="initial-loader" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="skeleton-loader skeleton-loader-card"></div>
          <div class="skeleton-loader skeleton-loader-card"></div>
          <div class="skeleton-loader skeleton-loader-card"></div>
          <div class="skeleton-loader skeleton-loader-card"></div>
        </div>
        <div class="skeleton-loader h-10 w-48"></div>
        <div class="skeleton-loader h-64"></div>
        <div class="skeleton-loader h-64"></div>
        <div class="skeleton-loader h-64"></div>
      </div>
      
      <div id="overview" class="tab-content bg-[#0d0d0d] border border-gray-700 p-6 rounded-xl shadow text-gray-200 hidden">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="p-4 border border-white/20 rounded-xl bg-[#1a1a1a] hover:bg-[#222] transition flex items-center justify-between shadow">
            <div>
              <p class="text-gray-400 text-sm">Pending contracts</p>
              <h3 id="pendingCount" class="text-2xl font-bold">0</h3>
            </div>
            <i class="fas fa-file-contract text-2xl text-red-500"></i>
          </div>
          <div class="p-4 border border-white/20 rounded-xl bg-[#1a1a1a] hover:bg-[#222] transition flex items-center justify-between shadow">
            <div>
              <p class="text-gray-400 text-sm">Total Contracts</p>
              <h3 id="totalCount" class="text-2xl font-bold">0</h3>
            </div>
            <i class="fas fa-file-contract text-2xl text-blue-400"></i>
          </div>
          <div class="p-4 border border-white/20 rounded-xl bg-[#1a1a1a] hover:bg-[#222] transition flex items-center justify-between shadow">
            <div>
              <p class="text-gray-400 text-sm">Revenue</p>
              <h3 class="text-2xl font-bold">$0</h3>
            </div>
            <i class="fas fa-chart-line text-2xl text-green-400"></i>
          </div>
          <div class="p-4 border border-white/20 rounded-xl bg-[#1a1a1a] hover:bg-[#222] transition flex items-center justify-between shadow">
            <div>
              <p class="text-gray-400 text-sm">Active Users</p>
              <h3 class="text-2xl font-bold">0</h3>
            </div>
            <i class="fas fa-users text-2xl text-purple-400"></i>
          </div>
        </div>

        <div class="flex flex-col md:flex-row gap-3 mb-6">
          <button onclick="openModal('addContractModal')" class="w-full md:w-auto px-5 py-2 rounded-xl bg-transparent border border-white/30 text-white hover:bg-white/10 hover:border-white/60 hover:scale-105 transition shadow-sm">
            <i class="fas fa-plus"></i> Add Contract
          </button>
        </div>

        <div class="p-6 border border-white/20 rounded-xl bg-[#1a1a1a] mb-6">
          <h3 class="text-lg font-bold mb-3">Revenue Overview</h3>
          <div class="w-full h-64 flex items-center justify-center text-gray-500 border-2 border-dashed border-white/30 rounded-lg">
            Chart Placeholder
          </div>
        </div>

        <div class="p-6 border border-white/20 rounded-xl bg-[#1a1a1a] mb-6">
          <h3 class="text-lg font-bold mb-3">Recent Activity</h3>
          <ul class="space-y-2 activity-log">
            <li class="p-3 border border-white/20 rounded-lg bg-[#0d0d0d] hover:bg-[#222] transition">No activity yet.</li>
          </ul>
        </div>

        <div class="p-6 border border-white/20 rounded-xl bg-[#1a1a1a]">
          <h3 class="text-lg font-bold mb-3">Recent Contracts</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-left border border-white/20 rounded-lg text-gray-300">
              <thead class="bg-[#111] text-gray-400">
                <tr>
                  <th class="px-4 py-2 border-b border-white/20">ID</th>
                  <th class="px-4 py-2 border-b border-white/20">Client</th>
                  <th class="px-4 py-2 border-b border-white/20">Status</th>
                  <th class="px-4 py-2 border-b border-white/20">Date</th>
                </tr>
              </thead>
              <tbody>
                <tr class="hover:bg-[#222] transition">
                  <td colspan="4" class="text-center text-gray-500 py-4">No contracts yet.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="contract" class="tab-content hidden p-6 text-center">
        <div class="text-4xl text-blue-400 mb-4">📑</div>
        <p class="text-xl mb-4">All active and pending Contracts are listed here.</p>
        
        <button onclick="openModal('dustContractModal')" class="w-full md:w-auto px-5 py-2 rounded-xl bg-yellow-600/20 text-yellow-400 border border-yellow-500 hover:bg-yellow-600/30 transition shadow-sm mb-6">
          <i class="fas fa-trash-alt"></i> Dust Contract
        </button>

        <div class="bg-gray-900 border border-gray-700 rounded-xl p-6 md:p-10 text-left">
          <h3 class="text-2xl font-bold text-white mb-4">Activate a Pending Contract</h3>
          <p class="text-gray-400 mb-6">To activate your contract, please enter the unique code from your payment receipt.</p>
          
          <div class="space-y-6">
            <div>
              <label for="autoGeneratedCode" class="block text-gray-300 text-sm font-medium mb-2">Auto-Generated Code</label>
              <input type="text" id="autoGeneratedCode" readonly placeholder="No code yet" class="w-full px-4 py-3 rounded-lg bg-white/5 border border-white/20 text-white placeholder-gray-500 cursor-not-allowed">
            </div>
            
            <div>
              <label for="newCodeOnReceipt" class="block text-gray-300 text-sm font-medium mb-2">Code on Receipt (Ends with 100)</label>
              <input type="text" id="newCodeOnReceipt" placeholder="Enter new code from receipt" class="w-full px-4 py-3 rounded-lg bg-white/5 border border-white/20 text-white placeholder-gray-500 focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-500/40 transition">
            </div>

            <button id="verifyBtn" onclick="verifyAndActivate()" class="w-full px-6 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white font-semibold shadow-md hover:shadow-lg transition">
              Verify and Activate
            </button>
            <p id="verification-status" class="mt-4 text-center text-sm font-semibold hidden"></p>
          </div>
        </div>
      </div>

      <div id="dust" class="tab-content hidden bg-gray-900 border border-gray-700 p-6 rounded-xl shadow text-gray-200">
        <div class="flex items-center gap-4 mb-4">
          <div class="text-4xl text-yellow-400">✨</div>
          <h2 class="text-2xl font-bold text-white">Dusted Contracts</h2>
        </div>
        <p class="text-gray-400 mb-6">
          This is where you can find contracts that have been archived or retired.
          They are no longer active, but you can restore them at any time.
        </p>
        
        <div id="dusted-contracts-list" class="space-y-4">
          <div class="text-center text-gray-500 py-10">No contracts have been dusted yet.</div>
        </div>
      </div>

      <div id="billing" class="tab-content hidden p-6 text-center">
        <div class="text-4xl text-pink-400 mb-4">💳</div>
        <p class="text-xl">Manage your Billing details, invoices, and receipts here.</p>
      </div>

      <div id="payment" class="tab-content hidden p-6 text-center">
        <div class="text-4xl text-purple-400 mb-4">💰</div>
        <p class="text-xl">View and process Payments securely from this section.</p>
      </div>

      <div id="settings" class="tab-content hidden p-6 text-center">
        <div class="text-4xl text-gray-400 mb-4">⚙️</div>
        <p class="text-xl">Customize your account, preferences, and security options here.</p>
      </div>
    </main>
  </div>

  <div id="mobileMenuModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden md:hidden z-50">
    <div class="absolute right-0 top-0 h-full w-64 bg-black border-l border-gray-700 slide-out-menu">
      <div class="p-6 border-b border-gray-700 flex justify-between items-center">
        <h2 class="text-2xl font-bold text-white">Menu</h2>
        <button id="closeMenu" class="p-2 rounded-lg text-white">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <nav class="flex-1 p-4 flex flex-col gap-2">
        <button class="nav-btn-mobile flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-800" data-tab="overview">
          <i class="fas fa-chart-line"></i> Overview
        </button>
        <button class="nav-btn-mobile flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-800" data-tab="contract">
          <i class="fas fa-file-contract"></i> Contract
        </button>
        <button class="nav-btn-mobile flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-800" data-tab="dust">
          <i class="fas fa-magic"></i> Dust
        </button>
        <button class="nav-btn-mobile flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-800" data-tab="billing">
          <i class="fas fa-receipt"></i> Billing
        </button>
        <button class="nav-btn-mobile flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-800" data-tab="payment">
          <i class="fas fa-dollar-sign"></i> Payment
        </button>
        <button class="nav-btn-mobile flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-800" data-tab="settings">
          <i class="fas fa-cog"></i> Settings
        </button>
      </nav>
    </div>
  </div>


  <div id="addContractModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center modal-overlay p-4">
    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 p-8 rounded-2xl border border-white/20 w-full max-w-lg shadow-2xl relative">
      <h2 class="text-2xl font-bold mb-6 text-white text-center">✨ Add Contract</h2>
      <label class="block text-gray-300 text-sm mb-2">User Name</label>
      <input id="userName" type="text" placeholder="Enter user name" class="w-full mb-5 px-4 py-3 rounded-xl bg-white/5 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-500/40 transition">
      <label class="block text-gray-300 text-sm mb-2">Contract Type</label>
      <select id="contractType" class="w-full mb-6 px-4 py-3 rounded-xl bg-white/5 border border-white/20 text-white focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-500/40 transition">
        <option class="bg-gray-900 text-white">Real Estate</option>
        <option class="bg-gray-900 text-white">2 Terms</option>
        <option class="bg-gray-900 text-white">Quick Productive</option>
        <option class="bg-gray-900 text-white">Binary</option>
        <option class="bg-gray-900 text-white">Development</option>
        <option class="bg-gray-900 text-white">Oil Reign</option>
        <option class="bg-gray-900 text-white">Infrastructure</option>
        <option class="bg-gray-900 text-white">Premium Quick Contract</option>
      </select>
      <div class="mb-8">
        <label class="block text-gray-300 text-sm mb-2">Contract Code</label>
        <div class="flex flex-col sm:flex-row gap-2">
          <input id="contractCode" type="text" readonly placeholder="Generate a code" class="flex-1 px-4 py-3 rounded-xl bg-white/5 border border-white/20 text-white placeholder-gray-500 focus:outline-none">
          <button onclick="generateContractCode()" class="px-4 py-3 rounded-xl bg-gradient-to-r from-green-500 to-emerald-400 hover:from-green-600 hover:to-emerald-500 text-white font-semibold shadow-md hover:shadow-lg transition">
            Create
          </button>
        </div>
      </div>
      <div class="flex flex-col sm:flex-row justify-end gap-3">
        <button onclick="closeModal('addContractModal')" class="px-5 py-3 rounded-xl bg-white/5 border border-white/20 text-white hover:bg-white/10 hover:border-white/40 transition">
          Close
        </button>
        <button id="saveBtn" onclick="continueContract()" class="px-5 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white font-semibold shadow-md hover:shadow-lg transition disabled:opacity-40" disabled>
          Continue
        </button>
      </div>
    </div>
  </div>

  <div id="loadingScreen" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center modal-overlay">
    <div class="flex flex-col items-center">
      <div class="animate-spin rounded-full h-20 w-20 border-t-4 border-b-4 border-blue-400 mb-4"></div>
      <p id="loading-message" class="text-white text-lg font-medium animate-pulse">Preparing your contract...</p>
    </div>
  </div>

  <div id="continueContractModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center modal-overlay p-4">
    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 p-8 rounded-2xl border border-white/20 w-full max-w-lg shadow-2xl text-center">
      <div class="flex justify-center mb-4">
        <i class="fas fa-file-contract text-4xl text-red-500"></i>
      </div>
      <div class="bg-red-600/20 border border-red-500 text-red-400 p-4 rounded-xl mb-6">
        <h2 class="text-xl font-bold mb-2">⚠️ Pending Contract</h2>
        <p class="text-sm">Your contract has been generated but is not yet active.<br>Please make a payment to activate your contract.</p>
      </div>
      <p class="text-gray-300 mb-3">Proceed to contract page to activate:</p>
      <button onclick="openTab('contract')" class="block w-full text-center px-6 py-3 rounded-xl bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white font-semibold shadow-md hover:shadow-lg transition">
        💳 Go to Contract Page
      </button>
      <button onclick="closeModal('continueContractModal')" class="mt-5 px-6 py-2 rounded-xl bg-white/10 border border-white/20 text-gray-300 hover:bg-white/20 hover:text-white transition">
        Close
      </button>
    </div>
  </div>
  
  <div id="verificationModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center modal-overlay p-4">
    <div class="bg-gray-900 p-8 rounded-2xl border border-gray-700 shadow-2xl w-full max-w-lg text-center">
        <div id="verificationIcon" class="mb-4">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-400"></i>
        </div>
        <h2 id="verificationTitle" class="text-xl font-bold mb-2 text-white">Verifying...</h2>
        <p id="verificationMessage" class="text-gray-400">Checking code...</p>
        <button id="closeVerificationBtn" onclick="closeModal('verificationModal')" class="mt-6 px-6 py-2 rounded-xl bg-gray-700 text-white hidden">Close</button>
    </div>
  </div>

  <div id="dustContractModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center modal-overlay p-4">
    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 p-8 rounded-2xl border border-white/20 w-full max-w-lg shadow-2xl relative">
      <h2 class="text-2xl font-bold mb-6 text-white text-center">Dust a Contract</h2>
      <p class="text-gray-400 mb-4 text-sm text-center">Select an active contract to move it to the "Dust" archive.</p>
      <select id="activeContractsDropdown" class="w-full mb-6 px-4 py-3 rounded-xl bg-white/5 border border-white/20 text-white focus:outline-none focus:border-yellow-400 focus:ring-2 focus:ring-yellow-500/40 transition">
        <option value="" disabled selected>-- Select a contract --</option>
      </select>
      <div class="flex flex-col sm:flex-row justify-end gap-3">
        <button onclick="closeModal('dustContractModal')" class="px-5 py-3 rounded-xl bg-white/5 border border-white/20 text-white hover:bg-white/10 hover:border-white/40 transition">
          Cancel
        </button>
        <button onclick="dustSelectedContract()" class="px-5 py-3 rounded-xl bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-semibold shadow-md hover:shadow-lg transition">
          <i class="fas fa-trash-alt"></i> Dust It
        </button>
      </div>
    </div>
  </div>

  <div id="restoreContractModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center modal-overlay p-4">
    <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 p-8 rounded-2xl border border-white/20 w-full max-w-lg shadow-2xl relative">
      <h2 class="text-2xl font-bold mb-6 text-white text-center">Restore a Contract</h2>
      <p class="text-gray-400 mb-4 text-sm text-center">Select a dusted contract to restore it to the active list.</p>
      <select id="dustedContractsDropdown" class="w-full mb-6 px-4 py-3 rounded-xl bg-white/5 border border-white/20 text-white focus:outline-none focus:border-green-400 focus:ring-2 focus:ring-green-500/40 transition">
        <option value="" disabled selected>-- Select a contract --</option>
      </select>
      <div class="flex flex-col sm:flex-row justify-end gap-3">
        <button onclick="closeModal('restoreContractModal')" class="px-5 py-3 rounded-xl bg-white/5 border border-white/20 text-white hover:bg-white/10 hover:border-white/40 transition">
          Cancel
        </button>
        <button onclick="restoreSelectedContract()" class="px-5 py-3 rounded-xl bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white font-semibold shadow-md hover:shadow-lg transition">
          <i class="fas fa-sync-alt"></i> Restore It
        </button>
      </div>
    </div>
  </div>
  
  <script>
    // ======= GLOBAL DATA (persistent with localStorage) =======
    let pendingContractsCount = parseInt(localStorage.getItem("pendingContractsCount")) || 0;
    let totalContractsCount = parseInt(localStorage.getItem("totalContractsCount")) || 0;
    let lastGeneratedCode = localStorage.getItem("lastGeneratedCode") || "";
    let contracts = JSON.parse(localStorage.getItem("contracts")) || [];
    let dustedContracts = JSON.parse(localStorage.getItem("dustedContracts")) || [];
    let recentActivity = JSON.parse(localStorage.getItem("recentActivity")) || [];

    function saveState() {
      localStorage.setItem("pendingContractsCount", pendingContractsCount);
      localStorage.setItem("totalContractsCount", totalContractsCount);
      localStorage.setItem("lastGeneratedCode", lastGeneratedCode);
      localStorage.setItem("contracts", JSON.stringify(contracts));
      localStorage.setItem("dustedContracts", JSON.stringify(dustedContracts));
      localStorage.setItem("recentActivity", JSON.stringify(recentActivity));
    }

    function getEl(id) {
      const el = document.getElementById(id);
      if (!el) console.warn(`Element #${id} not found`);
      return el;
    }

    function logActivity(message, type) {
      recentActivity.unshift({
        message: message,
        type: type,
        date: new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString(),
      });
      // Keep only the last 10 activities to prevent the list from getting too long
      if (recentActivity.length > 10) {
        recentActivity.pop();
      }
      saveState();
    }

    function renderCounts() {
      const p = getEl("pendingCount");
      const t = getEl("totalCount");
      if (p) p.textContent = String(pendingContractsCount);
      if (t) t.textContent = String(totalContractsCount);
    }

    function renderContracts() {
      const contractList = getEl("activeContractsDropdown");
      const contractTableBody = document.querySelector("#overview table tbody");
      if (!contractList || !contractTableBody) return;

      contractList.innerHTML = `<option value="" disabled selected>-- Select a contract --</option>`;
      contractTableBody.innerHTML = '';

      const activeContracts = contracts.filter(c => c.status === 'active');
      const pendingContracts = contracts.filter(c => c.status === 'pending');

      if (activeContracts.length === 0) {
        contractTableBody.innerHTML = `<tr class="hover:bg-[#222] transition"><td colspan="4" class="text-center text-gray-500 py-4">No contracts yet.</td></tr>`;
      } else {
        activeContracts.forEach(contract => {
          // Render to dropdown
          const option = document.createElement("option");
          option.value = contract.code;
          option.textContent = `${contract.userName} - ${contract.type}`;
          contractList.appendChild(option);

          // Render to table
          const row = document.createElement("tr");
          row.className = "hover:bg-[#222] transition";
          row.innerHTML = `
            <td class="px-4 py-2 border-b border-white/20">${contract.code.substring(0, 8)}...</td>
            <td class="px-4 py-2 border-b border-white/20">${contract.userName}</td>
            <td class="px-4 py-2 border-b border-white/20">
              <span class="px-2 py-1 rounded-full text-xs font-semibold ${contract.status === 'active' ? 'bg-green-600/20 text-green-400' : 'bg-red-600/20 text-red-400'}">
                ${contract.status}
              </span>
            </td>
            <td class="px-4 py-2 border-b border-white/20">${contract.date}</td>
          `;
          contractTableBody.appendChild(row);
        });
      }
    }

    function renderDustedContracts() {
      const dustedListContainer = getEl("dusted-contracts-list");
      if (!dustedListContainer) return;

      dustedListContainer.innerHTML = '';

      if (dustedContracts.length === 0) {
        dustedListContainer.innerHTML = `<div class="text-center text-gray-500 py-10">No contracts have been dusted yet.</div>`;
      } else {
        dustedContracts.forEach(contract => {
          const contractCard = document.createElement("div");
          contractCard.className = "flex items-center justify-between p-4 bg-gray-800 rounded-xl border border-gray-700 shadow";
          contractCard.innerHTML = `
            <div>
              <p class="font-semibold text-white">${contract.userName}</p>
              <p class="text-sm text-gray-400">${contract.type}</p>
              <p class="text-xs text-gray-500">${contract.code.substring(0, 10)}... <br> Dusted on: ${contract.date}</p>
            </div>
            <button onclick="restoreContract('${contract.code}')" class="px-4 py-2 rounded-lg bg-green-600/20 text-green-400 border border-green-500 hover:bg-green-600/30 transition">
              <i class="fas fa-sync-alt"></i> Restore
            </button>
          `;
          dustedListContainer.appendChild(contractCard);
        });
      }
    }

    function renderRecentActivity() {
      const activityList = document.querySelector("#overview .space-y-2");
      if (!activityList) return;

      activityList.innerHTML = '';
      if (recentActivity.length === 0) {
        activityList.innerHTML = `<li class="p-3 border border-white/20 rounded-lg bg-[#0d0d0d] hover:bg-[#222] transition">No activity yet.</li>`;
      } else {
        recentActivity.forEach(activity => {
          let icon = '';
          let color = '';
          if (activity.type === 'create') {
            icon = 'fas fa-plus-circle';
            color = 'text-blue-400';
          } else if (activity.type === 'activate') {
            icon = 'fas fa-check-circle';
            color = 'text-green-500';
          } else if (activity.type === 'dust') {
            icon = 'fas fa-trash-alt';
            color = 'text-yellow-400';
          } else if (activity.type === 'restore') {
            icon = 'fas fa-sync-alt';
            color = 'text-purple-400';
          }

          const listItem = document.createElement("li");
          listItem.className = "p-3 border border-white/20 rounded-lg bg-[#0d0d0d] hover:bg-[#222] transition flex justify-between items-center";
          listItem.innerHTML = `
            <div class="flex items-center gap-3">
                <i class="${icon} ${color}"></i>
                <span class="text-sm text-gray-300">${activity.message}</span>
            </div>
            <span class="text-xs text-gray-500">${activity.date}</span>
          `;
          activityList.appendChild(listItem);
        });
      }
    }

    function openModal(id) {
      const m = getEl(id);
      if (m) m.classList.remove("hidden");
    }
    function closeModal(id) {
      const m = getEl(id);
      if (m) m.classList.add("hidden");
    }

    // Slide-out menu functions
    const mobileMenuModal = getEl('mobileMenuModal');
    const slideOutMenu = mobileMenuModal.querySelector('.slide-out-menu');

    getEl('openMenu')?.addEventListener('click', () => {
      mobileMenuModal.classList.remove('hidden');
      setTimeout(() => slideOutMenu.classList.add('open'), 10);
    });

    getEl('closeMenu')?.addEventListener('click', () => {
      slideOutMenu.classList.remove('open');
      setTimeout(() => mobileMenuModal.classList.add('hidden'), 300);
    });

    mobileMenuModal.addEventListener('click', (e) => {
      if (e.target === mobileMenuModal) {
        getEl('closeMenu')?.click();
      }
    });

    function showLoading(forMs = 6000, after, message = "Preparing your contract...") {
      let overlay = getEl("loadingScreen");
      let loadingMessageEl = getEl("loading-message");
      if (!overlay || !loadingMessageEl) {
        console.error("Loading overlay elements not found.");
        return;
      }
      loadingMessageEl.textContent = message;
      overlay.classList.remove("hidden");
      setTimeout(() => {
        overlay.classList.add("hidden");
        if (typeof after === "function") after();
      }, forMs);
    }

    function validateFormEnableSave() {
      const name = getEl("userName")?.value.trim();
      const type = getEl("contractType")?.value;
      const code = getEl("contractCode")?.value.trim();
      const saveBtn = getEl("saveBtn");

      const isValid = Boolean(name && type && code);
      if (saveBtn) {
        saveBtn.disabled = !isValid;
        saveBtn.textContent = "Continue";
      }
    }

    function generateContractCode() {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      let code = "";
      for (let i = 0; i < 17; i++) code += chars.charAt(Math.floor(Math.random() * chars.length));
      code += "100"; // Ensure the code always ends in 100

      const codeInput = getEl("contractCode");
      if (codeInput) codeInput.value = code;
      lastGeneratedCode = code;
      saveState();
      validateFormEnableSave();
    }

    function continueContract() {
      const userName = getEl("userName")?.value.trim();
      const contractType = getEl("contractType")?.value;
      const contractCode = getEl("contractCode")?.value.trim();

      if (!userName || !contractType || !contractCode) {
        alert("Please fill in all fields before continuing.");
        return;
      }

      contracts.push({
        code: contractCode,
        userName: userName,
        type: contractType,
        status: 'pending',
        date: new Date().toLocaleDateString()
      });

      pendingContractsCount += 1;
      saveState();
      renderCounts();
      renderContracts();
      logActivity(`New pending contract created for ${userName}.`, 'create');
      renderRecentActivity();

      // Update the auto-generated code field on the contract tab
      const autoCodeField = getEl("autoGeneratedCode");
      if (autoCodeField) {
        autoCodeField.value = lastGeneratedCode;
      }

      closeModal("addContractModal");
      showLoading(3000, () => openModal("continueContractModal"), "Creating contract...");

      const nameEl = getEl("userName");
      const typeEl = getEl("contractType");
      const codeEl = getEl("contractCode");
      const saveBtn = getEl("saveBtn");

      if (nameEl) nameEl.value = "";
      if (typeEl) typeEl.selectedIndex = 0;
      if (codeEl) codeEl.value = "";
      if (saveBtn) saveBtn.disabled = true;
    }

    function verifyAndActivate() {
      const autoGeneratedCode = getEl("autoGeneratedCode")?.value.trim();
      const newCodeOnReceipt = getEl("newCodeOnReceipt")?.value.trim();
      const verificationStatusEl = getEl("verification-status");
      const verifyBtn = getEl('verifyBtn');

      if (!newCodeOnReceipt) {
        verificationStatusEl.textContent = "Please enter the code from your receipt.";
        verificationStatusEl.className = "mt-4 text-center text-sm font-semibold text-red-500";
        verificationStatusEl.classList.remove("hidden");
        return;
      }

      // Show spinner on the button
      verifyBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Verifying...`;
      verifyBtn.disabled = true;

      setTimeout(() => {
        let isCodeMatch = false;

        // Check for exact match AND that the code ends with 100
        if (newCodeOnReceipt === autoGeneratedCode && newCodeOnReceipt.endsWith("100")) {
          isCodeMatch = true;
        }

        if (isCodeMatch) {
          activateContract(autoGeneratedCode);
          verificationStatusEl.textContent = "Contract activated successfully!";
          verificationStatusEl.className = "mt-4 text-center text-sm font-semibold text-green-500";
          
        } else {
          verificationStatusEl.textContent = "The code is incorrect or does not end with '100'.";
          verificationStatusEl.className = "mt-4 text-center text-sm font-semibold text-red-500";
          alert("The code you entered is invalid. Please ensure it matches the auto-generated code and ends with '100'.");
        }

        // Restore button state
        verifyBtn.innerHTML = `Verify and Activate`;
        verifyBtn.disabled = false;
        verificationStatusEl.classList.remove("hidden");

        getEl('autoGeneratedCode').value = '';
        getEl('newCodeOnReceipt').value = '';
      }, 5000);
    }

    function activateContract(contractCode) {
      const contractIndex = contracts.findIndex(c => c.code === contractCode);
      if (contractIndex !== -1 && contracts[contractIndex].status === 'pending') {
        contracts[contractIndex].status = 'active';
        pendingContractsCount -= 1;
        totalContractsCount += 1;
        saveState();
        renderCounts();
        renderContracts();
        logActivity(`Contract "${contracts[contractIndex].userName}" activated.`, 'activate');
        renderRecentActivity();
      } else {
        const statusEl = getEl("verification-status");
        statusEl.textContent = "No pending contracts to activate.";
        statusEl.className = "mt-4 text-center text-sm font-semibold text-yellow-500";
        statusEl.classList.remove("hidden");
      }
    }

    function dustSelectedContract() {
      const dropdown = getEl("activeContractsDropdown");
      const selectedCode = dropdown.value;
      if (!selectedCode) {
        alert("Please select a contract to dust.");
        return;
      }

      // Find the contract to be dusted
      const contractIndex = contracts.findIndex(c => c.code === selectedCode);
      if (contractIndex === -1) {
        alert("Contract not found.");
        return;
      }

      const [contractToDust] = contracts.splice(contractIndex, 1);
      dustedContracts.unshift(contractToDust);
      totalContractsCount -= 1;
      saveState();
      closeModal('dustContractModal');
      renderContracts();
      renderDustedContracts();
      renderCounts();
      logActivity(`Contract "${contractToDust.userName}" was dusted.`, 'dust');
      renderRecentActivity();
      alert("Contract has been moved to the Dust archive.");
    }

    function restoreContract(contractCode) {
      const dustedContractIndex = dustedContracts.findIndex(c => c.code === contractCode);
      if (dustedContractIndex === -1) {
        alert("Dusted contract not found.");
        return;
      }

      const [contractToRestore] = dustedContracts.splice(dustedContractIndex, 1);
      contracts.unshift(contractToRestore);
      totalContractsCount += 1;
      saveState();
      renderContracts();
      renderDustedContracts();
      renderCounts();
      logActivity(`Contract "${contractToRestore.userName}" was restored from dust.`, 'restore');
      renderRecentActivity();
      alert("Contract has been restored to the active list.");
    }


    // Tab switching logic
    function openTab(tabId) {
      // Hide all tab content
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
      });

      // Remove active class from all nav buttons
      document.querySelectorAll('.nav-btn, .nav-btn-mobile').forEach(btn => {
        btn.classList.remove('bg-gray-700', 'text-white');
        btn.classList.add('hover:bg-gray-800');
      });

      // Show the selected tab content
      const selectedTab = getEl(tabId);
      if (selectedTab) {
        selectedTab.classList.remove('hidden');
      }

      // Add active class to the current button
      document.querySelectorAll(`.nav-btn[data-tab='${tabId}'], .nav-btn-mobile[data-tab='${tabId}']`).forEach(btn => {
        btn.classList.add('bg-gray-700', 'text-white');
        btn.classList.remove('hover:bg-gray-800');
      });

      // Update mobile header title
      const pageTitleMobile = getEl('page-title-mobile');
      if (pageTitleMobile) {
        pageTitleMobile.textContent = tabId;
      }
      // Update desktop header title
      const pageTitleDesktop = getEl('page-title');
      if (pageTitleDesktop) {
        pageTitleDesktop.textContent = tabId;
      }
      
      // Close the mobile menu if it's open
      getEl('closeMenu')?.click();
    }

    // Event listeners for tab switching
    document.querySelectorAll('.nav-btn, .nav-btn-mobile').forEach(button => {
      button.addEventListener('click', (e) => {
        const tab = e.currentTarget.dataset.tab;
        openTab(tab);
      });
    });

    // Initial render on page load
    document.addEventListener("DOMContentLoaded", () => {
        // Simulate a brief load
        const loader = getEl("initial-loader");
        const overviewTab = getEl("overview");
        setTimeout(() => {
            loader.classList.add("hidden");
            overviewTab.classList.remove("hidden");
            renderCounts();
            renderContracts();
            renderDustedContracts();
            renderRecentActivity();
            openTab('overview'); // Set initial tab after loading
        }, 1500); // 1.5-second delay
    });
  </script>
</body>
</html>
